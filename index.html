<!DOCTYPE html>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css">

  <style>
    nav {
      height: 100%;
    }

    nav h2 {
      margin: 0;
      padding: 1.78rem 0 1.424rem 0;
    }

    .row {
      margin: 0;
    }

    .col {
      height: 100vh;
      overflow: auto;
    }

    textarea {
      font-family: 'Roboto Mono';
    }

    textarea.materialize-textarea {
      border-color: #f5f5f5;
    }

    textarea.materialize-textarea:focus:not([readonly]) {
      box-shadow: 0 1px 0 0 #f5f5f5;
    }
  </style>
<nav>
  <div class="nav-wrapper blue-grey lighten-5 grey-text text-darken-3">
    <h2 class="header center-align">Codex: Live Preview Demo</h2>
  </div>
</nav>

<div class="row">
  <div class="col s6 light-blue">
    <h3 class="header white-text center-align">Codex Input</h3>

    <div class="input-field">
      <textarea id="input-textarea" class="materialize-textarea grey-text text-lighten-4">location (key)
A113 (and value are separated by a newline)

profile.username (you can add comments between parentheses)
hirschfeldnina (all values are strings or numbers)

profile.luckynumber (two or more newlines separate key-value pairs)
42 (numbers are automatically detected)



profile.org
funsociety

profile.id 
'4815162342' (but, you can explicitly make number-like stuff a string)

profile.codename
"007"

websites (multiple values make an array)
218.108.149.373
192.251.68.239
192.251.68.254
i239.bxjyb2jvda.net
conficturaindustries.com

profile.twitter (the order doesn't matter; the profile values did't have to be grouped)
https://twitter.com/1231507051321

(There are no nested representations beyond the ones above [arrays and flat objects].
Instead, we encourage the use of separate files 
[instead of using arrays of objects or objects of objects, etc].)
      </textarea>
    </div>
  </div>

  <div class="col s6 teal">
    <h3 class="header white-text center-align">Generated Object</h3>

    <div class="input-field">
      <textarea id="output-textarea" class="materialize-textarea grey-text text-lighten-4">{
  "location": "A113",
  "profile": {
    "username": "hirschfeldnina",
    "luckynumber": 42,
    "org": "funsociety",
    "id": "4815162342",
    "codename": "007",
    "twitter": "https://twitter.com/1231507051321"
  },
  "websites": [
    "218.108.149.373",
    "192.251.68.239",
    "192.251.68.254",
    "i239.bxjyb2jvda.net",
    "conficturaindustries.com"
  ]
}</textarea>
    </div>
  </div>

</div>

<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/js/materialize.min.js"></script>
<script>
  var source = document.querySelector('#input-textarea');
  var target = document.querySelector('#output-textarea');

  source.addEventListener('input', changeOutput);

  function changeOutput() {
    try {
      var result = parse(source.value);
      target.value = JSON.stringify(result, null, '  ');
    } catch(e) {
      console.log('Error parsing:', e);
    }
    
  }

  function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
  }

  function parseString(string) {
    var quotes = ['\'', '"'];

    if (quotes.indexOf(string.charAt(0)) !== -1 &&
      quotes.indexOf(string.charAt(string.length - 1)) !== -1) {
      return string.slice(1, string.length - 1);
    }

    return string;
  }

  function parseValue(value) {
    return isNumber(value) ? Number(value) : parseString(value);
  }

  function parseValues(values) {
    if (values.length === 1) {
      return parseValue(values[0]);
    }

    return values.map(function(value) {
      return parseValue(value);
    });
  }

  function parse(text) {
    var codex = {};

    var uncommentedText = text.replace(/\([^\)]*\)/g, '');

    var newlineNormalizedText = uncommentedText.replace(/\r\n/g, '\n').
      replace(/[\s]*\n\n[\s]*/g, '\n\n');

    var pairs = newlineNormalizedText.split('\n\n');

    pairs.forEach(function(pair) {
      if (!pair) {
        return;
      }

      var values = pair.split('\n').map(function(string) {
        return string.trim();
      });

      var key = values.shift();

      if (key.indexOf('.') !== -1) {
        var keys = key.split('.');

        if (!codex[keys[0]]) {
          codex[keys[0]] = {};
        }

        codex[keys[0]][keys[1]] = parseValues(values);
      } else {
        codex[key] = parseValues(values);
      }
    });

    return codex;
  }
</script>
